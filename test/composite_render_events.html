<!DOCTYPE HTML>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=ISO-8859-1">
    <title>Seanox aspect-js test environment</title>
    <style type="text/css">
      body {
        font-family:monospace;
      }
      body div {
        margin:1em;
      }
    </style>
    <script src="../sources/extension.js"></script>
    <script src="../sources/composite.js"></script>
    <script src="../sources/test.js"></script>
    <script src="../sources/testutils.js"></script>
    <script type="text/javascript">
    
      var aComp = {
              text1:null,
              text2:null,
              text3:null,
              text4:null,
              text5:null,
              text6:null,
              text7:null,
              text8:null,
              text8_1:null,
              text8_2:null,
              text9:null    
      };
      var bComp = {
              text3:null,
              text4:null,
              text9:null              
      };
      var cComp = {};
      var fComp = {
              text1:null,
              text2:null,
              text5:null
      };
      
      var pattern = null;

      Test.create({test:function() {
          var x = 0;
          if (pattern.shift() == aComp.toPlainString()) x++;
          if (pattern.shift() == aComp.toPlainString()) x++;
          Assert.assertEquals(1, x);
      }});    

      Test.create({test:function() {
          Assert.assertEquals(pattern.shift(), bComp.toPlainString());
      }});    

      Test.create({test:function() {
          Assert.assertEquals(pattern.shift(), cComp.toPlainString());
      }});    
      
      Test.create({test:function() {
          Assert.assertEquals(pattern.shift(), String(typeof dComp));
      }});    

      Test.create({test:function() {
          Assert.assertEquals(pattern.shift(), String(typeof eComp));
      }});    

      //aComp contains a mix of sub-composites and fields with absolute namespace.
      //Synchronization must primarily take place in fComp.
      
      //fComp: text1, text2, text5 are defined in the model and the value must be synchronized
      //fComp: text9 are not defined in the model and the value must not be synchronized
      //The value must not then be bubbled upwards.
      
      Test.create({test:function() {
          Assert.assertEquals(pattern.shift(), fComp.toPlainString());
      }});    

      Test.create({test:function() {
          Assert.assertTrue(!aComp.text8_1);
      }});    
      Test.create({test:function() {
          Assert.assertEquals(pattern.shift(), aComp.text8_2);
      }});    
      
      Element.prototype.typeTestValue = function() {
          this.typeValue(this.id + "-X");
      };

      var count = 0;
      Composite.listen(Composite.EVENT_RENDER_END, function() {
          switch (++count) {
              case 1:
                  pattern = document.querySelector("script[type='text/test']").textContent.trim();
                  pattern = pattern.split(/\s*[\r\n]+\s*/m);
                  text3.typeTestValue();
                  text4.typeTestValue();
                  text6.typeTestValue();
                  text7.typeTestValue();
                  text8.typeTestValue();
                  text9.typeTestValue();
                  window["fComp.text1"].typeTestValue();
                  window["fComp.text2"].typeTestValue();
                  window["fComp.text5"].typeTestValue();
                  return;
              case 2:
                  aComp.text8_1 = aComp.text8;
                  text8.trigger("focus"); 
                  return; 
              case 3:
                  aComp.text8_2 = aComp.text8;
                  window.setTimeout(Test.start, 250);
                  return;
          }
      });     
    </script>
    <script type="text/test">
      {"text1":null,"text2":null,"text3":null,"text4":null,"text5":null,"text6":null,"text7":"text7-X","text8":"text8-X","text8_1":null,"text8_2":"text8-X","text9":null}
      {"text1":null,"text2":null,"text3":null,"text4":null,"text5":null,"text6":null,"text7":"text7-X","text8":"text8-X","text8_1":"","text8_2":"text8-X","text9":null}
      {"text3":null,"text4":null,"text9":null}
      {}
      undefined
      undefined
      {"text1":"fComp.text1-X","text2":"fComp.text2-X","text5":"fComp.text5-X"}
      text8-X
    </script>
  </head>
  <body>
    <div id="aComp" composite>
      <input type="text" id="fComp.text1" events="change">
      <div id="bComp" composite>
        <input type="text" id="fComp.text2" events="change">
        <div id="cComp" composite>
          <input type="text" id="text3" events="change">
          <input type="text" id="text4" events="change">
          <input type="text" id="text9" events="change">
        </div>
        <input type="text" id="fComp.text5" events="change">
      </div>
      <input type="text" id="text6">
      <input type="text" id="text7" events="change">
      <input type="text" id="text8" events="focus" render="#text7, #text7">
    </div>
  </body>
</html>