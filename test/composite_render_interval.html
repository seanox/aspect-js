<!DOCTYPE HTML>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=ISO-8859-1">
    <title>Seanox aspect-js test environment</title>
    <style type="text/css">
      body {
        font-family:monospace;
      }
    </style>
    <script src="aspect-js.js"></script>
    <script type="text/javascript"> 
    
        Test.activate();
        
        var results = [];
        
        var a1 = 0;
        var b1 = 0;
        var c1 = 0;
        var a2 = 0;
        var b2 = 0;
        var c2 = 0;
        
        var aCondition = false; 
        
        var snapshots = [];
        Composite.listen(Composite.EVENT_RENDER_END, function() {
            if (typeof Test.started !== "undefined")
                return;
            Test.started = true;
            
            (new MutationObserver(function(records) {
                records.forEach(function(record) {
                    
                    var snapshot = document.body.textContent;
                    snapshot = snapshot.replace(/^\s+/mg, "");
                    snapshot = snapshot.replace(/(:)\s+/g, "$1 ");
                    snapshot = snapshot.replace(/\sout.*?;/g, "");
                    snapshot = snapshot.replace(/\sPlease.*$/im, "");
                    snapshot = snapshot.replace(/:\s+(\S+)/g, "=$1;");
                    snapshots.push(snapshot);
                    
                    if (snapshots.length == 25) {
                        aCondition = true; 
                        Composite.asynchron(Composite.render, document.body);
                    }
                    if (snapshots.length == 50) {
                        aCondition = false; 
                        Composite.render("#TestA");                       
                    }
                    if (snapshots.length == 75) {
                        aCondition = true; 
                        Composite.asynchron(Composite.render, document.body);
                    }
                    
                    if (snapshots.length == 100)
                        Composite.asynchron(() => {
                            document.body.textContent = "Please wait, test in progress...";
                            Test.start();
                        });
                });
            })).observe(document.body, {childList:true, subtree:true, attributes:true, characterData:true});
        });
        
        snapshots.eval = function(index) {
            delete A;
            delete B;
            delete C;
            delete S1;
            delete S2;
            eval(snapshots[index]);
        };
        
        Test.create({test:function() {
            snapshots.eval(3);
            Assert.assertTrue(typeof A === 'undefined');
            Assert.assertTrue(typeof B !== 'undefined');
            Assert.assertTrue(typeof C !== 'undefined');
            Assert.assertTrue(typeof S1 !== 'undefined');
            Assert.assertTrue(typeof S2 !== 'undefined');
            Assert.assertTrue(B == C && B > 1);
            Assert.assertTrue(S1 == S2 && S1 == 1);    
        }}); 
        Test.create({test:function() {
            snapshots.eval(20);
            Assert.assertTrue(typeof A === 'undefined');
        }}); 
        Test.create({test:function() {
            snapshots.eval(20);
            Assert.assertTrue(B > C);
            Assert.assertTrue(S1 < S2);    
        }}); 
        Test.create({test:function() {
            snapshots.eval(45);
            Assert.assertTrue(typeof A !== 'undefined');
        }});   
        Test.create({test:function() {
            snapshots.eval(45);
            if (navigator.engine == "edge") {
                Assert.assertTrue(A == 2 && B == 2 && C == 2);
                Assert.assertTrue(S1 == 1 && S2 == 1);              
            } else if (navigator.engine == "blink") {
                Assert.assertTrue(A == 3 && B == 2 && C == 1);
                Assert.assertTrue(S1 == 1 && S2 == 2); 
            } else if (navigator.engine == "webkit") {
                Assert.assertTrue(A == 3 && B == 2 && C == 1);
                Assert.assertTrue(S1 == 1 && S2 == 2);                 
            } else {
                Assert.assertTrue(A == 3 && B == 2 && C == 2);
                Assert.assertTrue(S1 == 1 && S2 == 2);              
            }
        }});   
        Test.create({test:function() {
            snapshots.eval(55);
            Assert.assertTrue(typeof A === 'undefined');
        }});       
        Test.create({test:function() {
            snapshots.eval(55);
            Assert.assertTrue(B >= C);
            Assert.assertTrue(S1 <= S2);    
        }});       
    </script>
  </head>
  <body>
    {{xA:0}}
    <div id="TestA" interval="{{300 +30 +3}}" condition="{{aCondition}}">
      {{xA:parseInt(xA)+1}}
      A: {{xA}}
    </div>
    <div id="TestBC">
      {{xB:0}}
      <div id="TestB" interval="555">
        {{xB:parseInt(xB)+1}}
        B: {{xB}}
      </div>
    </div>
    <div id="TestCC">
      <div>
        <div>
          {{xC:0}}
          <div id="TestC" interval="777">
            {{xC:parseInt(xC)+1}}
            C: {{xC}}
          </div>
        </div>
      </div>
    </div>
    S1: {{s1:0}}
    <div id="outputScript1"></div>
    <script type="composite/javascript" interval="3000">
        outputScript1.textContent = ++s1;
    </script>
    S2: {{s2:0}}
    <div id="outputScript2"></div>
    <script type="composite/javascript" interval="1500">
        outputScript2.textContent = ++s2;
    </script>
    <br>
    Please wait, test in progress...
  </body>
</html>