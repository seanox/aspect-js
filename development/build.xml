<?xml version="1.0" ?>
<project name="aspect-js" default="usage" basedir="..">
  <target name="usage">
    <echo>                                                    </echo>
    <echo> the following targets are available ...            </echo>
    <echo>                                                    </echo>
    <echo>   archive    builds the final scripts and creates  </echo>
    <echo>              the archives for the distribution.    </echo>
  </target>
  
  <property name="workspace" value="${basedir}"/>
  <property name="workspace.sources" value="${workspace}/sources"/>
  <property name="workspace.development" value="${workspace}/development"/>
  <property name="workspace.releases" value="${workspace}/releases"/>
    
  <macrodef name="release-locate">
    <sequential>
      <copy file="${workspace.development}/release.txt" tofile="${workspace.development}/release.tmp" overwrite="true"/>
      <replaceregexp file="${workspace.development}/release.tmp"
        match="(?s)^\s*([\d\.x]+) (\d{4})([\dx]+).*$" flags="g" byline="false"
        replace="release.version=\1&#x000D;release.year=\2&#x000D;release.date=\2\3&#x000D;"/>
      <replaceregexp file="${workspace.development}/release.tmp" match="x+" replace="0000" flags="g" byline="false"/>
      <loadproperties>
        <file file="${workspace.development}/release.tmp"/>
      </loadproperties>
      <delete file="${workspace.development}/release.tmp"/>
    </sequential>
  </macrodef> 
  
  <macrodef name="compress-javascript">
    <attribute name="file"/>
    <sequential>
      <echo>Compressing: @{file}</echo>
      <replaceregexp file="@{file}" match="([^\s\\])(/\*)" flags="g" replace="\1\\\\\2" byline="false"/>
      <replaceregexp file="@{file}" match="([^\s\\])(/)(/)" flags="g" replace="\1\\\\\2\\\\\2" byline="false"/>
      <replaceregexp file="@{file}" match="(?s)(?&lt;!\\)\/\*.*?\*/" flags="g" replace="" byline="false"/>
      <replaceregexp file="@{file}" match="\s*//.*$" flags="g" replace="" byline="true"/>
      <replaceregexp file="@{file}" match="\t" flags="g" replace=" " byline="true"/>
      <replaceregexp file="@{file}" match="(?s)\s*[\r\n]+" flags="g" replace="${line.separator}" byline="false"/>
      <replaceregexp file="@{file}" match="(?s)(\{)[\r\n]+\s*" flags="g" replace="\1" byline="false"/>
      <replaceregexp file="@{file}" match="(?s)[\r\n]+ +(?=\})" flags="g" replace="" byline="false"/>
      <replaceregexp file="@{file}" match="(?s)[\r\n]+ +(?!\})" flags="g" replace=" " byline="false"/>
      <replaceregexp file="@{file}" match="(?s)[\r\n]+ *(\})" flags="g" replace="\1" byline="false"/>
      <replaceregexp file="@{file}" match="(?i)[\r\n]+([a-z0-9_\.]+\s*[=;])" flags="g" replace=" \1" byline="false"/>
      <replaceregexp file="@{file}" match="^\s+" flags="g" replace="" byline="false"/>
      <replaceregexp file="@{file}" match="\s+$" flags="g" replace="" byline="true"/>
    </sequential>
  </macrodef>
  
  <target name="archive">
    <release-locate/>

    <property name="release.min" value="${workspace.releases}/${ant.project.name}-${release.version}-min.js"/>
    <concat destfile="${release.min}">
      <fileset file="${workspace.sources}/extension.js"/>
      <fileset file="${workspace.sources}/messages.js"/>
      <fileset file="${workspace.sources}/datasource.js"/>
      <fileset file="${workspace.sources}/composite.js"/>
      <fileset file="${workspace.sources}/mvc.js"/>
      <fileset file="${workspace.sources}/test.js"/>
    </concat>
    <replaceregexp file="${release.min}" match="(?s)(?&lt;=\S)(/\*\*)" flags="g" replace="${line.separator}${line.separator}\1" byline="false"/>
    <compress-javascript file="${release.min}"/>
    
    <property name="release.dev" value="${workspace.releases}/${ant.project.name}-${release.version}-dev.js"/>
    <concat destfile="${release.dev}">
      <fileset file="${workspace.sources}/extension.js"/>
      <fileset file="${workspace.sources}/messages.js"/>
      <fileset file="${workspace.sources}/datasource.js"/>
      <fileset file="${workspace.sources}/composite.js"/>
      <fileset file="${workspace.sources}/mvc.js"/>
      <fileset file="${workspace.sources}/test.js"/>
    </concat>    
    <replaceregexp file="${release.dev}" match="(?s)(?&lt;=\S)(/\*\*)" flags="g" replace="${line.separator}${line.separator}\1" byline="false"/>
    <replaceregexp file="${release.dev}" match="(?s)(?&lt;=.)(?:(/\*(?:\*\s+)+)LIZENZBEDINGUNGEN.*?----\s+\*\s+)" flags="g" replace="\1" byline="false"/>
    
    <!-- TODO: build zip files for distribution (dev + min = js + licence + release.txt) -->
    <!-- TODO: target test-dev + test-min, to build the release and configure the test environment -->
  </target>
</project>